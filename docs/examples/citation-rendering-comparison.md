# Before/After 比較: RAG 引用リナンバリング問題

## 条件

- **同じ問題**: RAG ストリーミングにおける引用参照のリアルタイム描画
- **Before**: 通常プロンプト（「設計分析と解決策を提案してください」）
- **After**: 論文形式プロンプト（`/paper-driven-dev:article`）

## 構造の比較

| 観点 | Before（通常プロンプト） | After（論文形式） |
| --- | --- | --- |
| **全体構造** | 結論→理由→提案→コード例の4段構成 | §1〜§7 の7セクション構成 |
| **分量** | 約40行 | 約270行 |
| **問題定義** | 1段落の概要 | §1.1 背景 + §1.2 矛盾する2要求の形式的定義 |
| **既存手法の分析** | なし（提案のみ） | 5つのアプローチを手法/利点/限界で体系的に比較 |
| **問題の本質** | 「なぜ難しいか」を3行で列挙 | §4 で根本原因を特定し具体例で証明 |
| **提案手法** | アルゴリズムとコード例 | 基本原理 + 採番規則 + 不変条件 + アーキテクチャ図 + 実装詳細 |
| **検証可能性** | なし | 4つのテスト可能な性質（整合性/Append-Only/連番/安全な劣化） |
| **限界の明示** | 1行の条件分岐 | 3つの制約を具体的に記述 |

## 品質の比較

### 1. 先行事例の調査

| | Before | After |
| --- | --- | --- |
| **列挙された手法** | 0 | 5（スピナー表示、手動パーサー、LLM直接採番、ギャップ許容、仮番号差し替え） |
| **各手法の限界** | — | 具体的に記述（例: LLM採番エラー、番号ジャンプ） |

Before は「こうすればいい」と解を直接提示します。After は「他の方法ではなぜダメか」を先に分析し、消去法で提案に至ります。

### 2. トレードオフの定義

| | Before | After |
| --- | --- | --- |
| **矛盾する要求の特定** | 暗黙的 | 要求A（リアルタイム表示）vs 要求B（正しい連番）として明示 |
| **矛盾の本質** | 「全文未確定」の一言 | リナンバリングが全文確定を要求する一方、ストリーミングは全文未確定であるという構造的矛盾 |

### 3. 提案の正当化

| | Before | After |
| --- | --- | --- |
| **なぜこの方式か** | 「最適です」（主張のみ） | §3 の5手法の限界分析 → §4 の本質特定 → §5 の原理導出 |
| **不変条件** | append-only を1行で言及 | 形式的に定義（prefix 関係による数学的記述） |
| **サーバー/クライアント一致** | 「バックエンドで決定」 | 同一純関数の共有による構造的保証 |

### 4. テスト条件の導出

| | Before | After |
| --- | --- | --- |
| **テスト可能な性質** | 0 | 4（整合性、Append-Only、連番、安全な劣化） |
| **実装への接続** | コード例あり（局所的） | 性質からテストケースを導出可能 |

Before のコード例は「何を実装するか」を示しますが、「何をテストすべきか」は示しません。After の §6 は実装前にテスト設計を可能にします。

### 5. 限界と制約

| | Before | After |
| --- | --- | --- |
| **制約の数** | 1（過去文書き換え時の注意） | 3（summary採番、JSON順序依存、引用途中出現） |
| **対策の具体性** | 「2段階方式が安全」 | 各制約に具体的な回避策を記述 |

## まとめ

通常プロンプトの出力は**正しい結論に到達**しています。提案されたアルゴリズムは論文形式の出力と本質的に同じです。

差が出るのは**結論に至るプロセスの質**です:

1. **Why の深さ**: Before は「何をするか」、After は「なぜそうするか」
2. **代替案の検討**: Before は0件、After は5件の既存手法を分析
3. **検証可能性**: Before は0件、After は4つのテスト可能な性質を定義
4. **限界の誠実さ**: Before は1件、After は3件の制約を明示

論文形式は「正しい答えを出す」ためではなく、「答えの正しさを検証可能にする」ために効果的です。
