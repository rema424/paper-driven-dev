# Calibration #002

# ストリーミングRAGにおける引用のオンライン・リナンバリング手法
— 構造化JSON出力（`{ body, citedSourceIds }`）を対象として —

## 要旨
RAG（Retrieval-Augmented Generation）システムでLLMがストリーミング生成する本文中に、検索結果ID（例：`[source_7]`）として埋め込まれた引用参照を、ユーザー表示では使用した引用のみの連番（`[1],[2],...`）へ変換する必要がある。しかしストリーミングでは全文が未確定であり、オフライン前提の番号付けは困難に見える。本稿は、**番号規則を「初出順（first-appearance order）」として定義**することで、本文を巻き戻さずに**オンライン（逐次）で確定番号を付与できる**ことを示し、実装に必要な状態管理・パーサ設計・整合性検査を整理する。

**キーワード**：RAG、ストリーミング生成、引用、オンラインアルゴリズム、UIレンダリング

---

## 1. はじめに
RAGでは、LLM出力の根拠提示として検索結果（ソース）への参照を本文に埋め込み、閲覧者には脚注形式の連番で提示することが多い。ところが、LLMが参照するのは検索結果の"元番号"（`source_3`等）であり、ユーザー向けには「実際に引用されたものだけ」を詰めた連番が望ましい。一方、ストリーミングでは将来どのソースが引用されるか分からず、最終番号を先に確定できない、という課題がある。

---

## 2. 問題設定
### 2.1 入力・出力
- LLMストリーミング出力：
  `body`: 文字列（途中に`[source_N]`が現れる）
  `citedSourceIds`: ソースID配列（必ずしもストリーミング中に確定しない／LLMが正しく出す保証も弱い）

- UI表示要件：
  - 本文中の参照は **`[1],[2],...` の連番**で表示
  - 連番は **"使用した引用のみ"**（未使用ソースは番号を持たない）
  - ストリーミング中も **表示が破綻せず、確定番号として扱える**こと

### 2.2 本質的な難しさ
「最終的に使われた引用集合」や「番号の並び規則」が未来の出力に依存すると、ストリーミングの時点で正しい番号を決められない。したがって、リアルタイムに確定番号を出すには、**番号付け規則が"前から順に確定できる（prefix決定可能）"**である必要がある。

---

## 3. 提案手法：初出順に基づくオンライン・リナンバリング
### 3.1 番号付け規則（仕様として固定する）
本稿は表示番号の定義を次で固定する：

> **表示番号＝本文中でそのソースIDが最初に出現した順序（初出順）**

この定義により、ストリーミングで本文が左から右へ増える限り、番号は**将来のテキストに影響されず**に確定できる。

### 3.2 オンラインアルゴリズム
状態として以下を保持する：
- `map`: `sourceId -> displayNumber`（未登録なら未出）
- `next`: 次に割り当てる番号（初期値1）
- `orderedCitedSourceIds`: 初出順に並んだ`sourceId`の配列（= UIの脚注リストの順）

ストリーム中に`[source_k]`を検出したら：
1. `source_k`が`map`未登録なら
   `map[source_k] = next`、`orderedCitedSourceIds.push(source_k)`、`next++`
2. 本文表示は`[map[source_k]]`に置換して出力（同一ソースは常に同じ番号）

これにより、表示は常に`[1..m]`の連番で、欠番が発生しない。

---

## 4. 正当性（なぜストリーミングでも"最終結果と一致"するか）
**命題**：番号規則を初出順としたとき、上記アルゴリズムが出力する番号は、全文確定後に全文を走査して初出順で割り当てた結果と一致する。

**理由**：あるソース`s`の表示番号は「`s`より前に初めて現れた異なるソースの個数+1」で決まる。ストリーミング中に`[source]`が初めて現れた瞬間、その時点までの前方テキストはすでに確定しており、将来の追加テキストは` s `の"前"に挿入されない（追記のみ）ため、この個数は以後変化しない。よって割当番号は将来に依存せず確定する。

---

## 5. 実装上の考慮点（ストリーミングで壊れないために）
### 5.1 参照トークンの検出（チャンク境界問題）
`[sou` + `rce_7]`のように引用トークンが分割され得るため、レンダラ側は
- 小さな未確定バッファ（末尾数十文字）を保持
- `[`開始〜`]`終端までを有限状態機械で復元
して確定した参照のみ置換する設計が必要である。

### 5.2 UIレンダリング：文字置換より「参照ノード」化
本文を単純に文字列連結するより、`[n]`部分を
- `data-source-id="source_7"` を持つ参照ノード（DOM要素等）
として描画すると、リンク付け・ホバー表示・後段の整合性修正が容易になる。

### 5.3 `citedSourceIds`の扱い（LLM出力を鵜呑みにしない）
`citedSourceIds`は（i）順序が不定、（ii）本文と不整合、（iii）ストリーミング中未確定、が起こり得る。したがって実務上は：
- **本文から検出した初出順 `orderedCitedSourceIds` を"正"**とし、
- LLMの`citedSourceIds`は検査・警告・補助情報として扱う
方が堅牢である。

---

## 6. 議論：不可能性と回避策
### 6.1 初出順以外は「巻き戻し無し」では一般に不可能
もし番号規則が「最終的な引用集合をソートして番号付け」など、未来の出力に依存する場合、ストリーミング時点で確定番号を保証できない。回避は次のいずれかになる：
- (A) **暫定番号**（後で差し替え）を許す
- (B) 出力完了後に **全文を再レンダリング**（差分更新）する
- (C) 仕様を **初出順**のようなオンライン確定可能な規則に変更する

### 6.2 出力スキーマ改善案（パース事故の低減）
本文に埋め込む代わりに、`bodySegments: [{text, citeIds}]`のようなセグメント配列にすれば、チャンク境界での誤検出が減り、参照を構造として処理できる（ただし既存スキーマ変更コストがある）。

---

## 7. 結論
ストリーミングRAGで「使用引用のみの連番」をリアルタイムに正しく描画するには、**表示番号の仕様を"初出順"として固定**し、クライアント側で **`sourceId -> 連番` の写像を初出時に確定**するオンライン手法が有効である。これにより、全文未確定という制約下でも番号が後から変わらず、UIの一貫性を保ったままストリーミング表示を実現できる。
