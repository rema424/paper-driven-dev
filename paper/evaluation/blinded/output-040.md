# Output #040

# ストリーミングRAGにおける不変引用番号付与方式の設計分析

## 要旨
本稿は、RAGシステムのストリーミング生成中に、内部ID（`source_3` など）を可読な連番引用（`[1]`, `[2]`）へ変換する設計を示す。要件は、(1) リアルタイム表示、(2) 一度表示した番号の不変性、(3) 完了時の参照一覧との整合性である。提案方式は「初出順の単調割当（Online Monotonic Allocation）」であり、同一の状態機械をストリーム中と終了時で共有することで、3要件を同時に満たす。

## 1. 問題設定
生成イベント列を $E=\{e_t\}$ とし、各イベントはテキスト断片または引用集合 $C_t\subseteq R$（検索結果集合 $R$ 上の内部ID）を持つ。
求める写像 $f:R\to \mathbb{N}$ は以下を満たす必要がある。

1. 引用イベント到着時に即時に表示可能。
2. 一度決めた $f(s)$ は後で変更しない。
3. 最終参考文献一覧 $B$ と本文中引用が一致する。

## 2. 提案方式
### 2.1 中核アイデア
- `source_id -> citation_number` の辞書をストリーム単位で保持する。
- 引用IDの初出時のみ次番号を採番する（1,2,3,…）。
- 既出IDは既存番号を再利用する。
- 終了時の参照一覧は、この辞書から番号順に生成する。

### 2.2 擬似コード
```text
state:
  map M = {}              // source_id -> number
  list L = []             // number順のsource_id
  next = 1

on_citation(ids):
  nums = []
  for s in ids:
    if s not in M:
      M[s] = next
      L.append(s)
      next += 1
    nums.append(M[s])
  emit_inline_citation(nums)   // 例: [2][5]

on_finalize():
  for i, s in enumerate(L, start=1):
    emit_bibliography_item(i, metadata(s))
```

## 3. 要件適合性の分析
### 3.1 リアルタイム表示
`on_citation` は到着イベントごとに局所処理でき、ハッシュ辞書により平均 $O(1)$ で採番可能。よってストリーミング遅延をほぼ増やさない。

### 3.2 番号不変性
`M[s]` は「未定義→定義済み」への一度だけの遷移で、更新操作を禁止する設計とする。したがって表示済み番号は不変である。

### 3.3 完了時整合性
本文引用と参考文献一覧が同一状態 `M/L` から生成されるため、参照先不一致が起きない。
すなわち、本文に現れる全番号は一覧に存在し、一覧の各番号は対応する `source_id` を一意に持つ。

## 4. 実装上の重要点
1. LLMには番号ではなく構造化引用トークン（例: `<<cite:source_7>>`）を出力させる。
2. 採番は単一のシリアライズ点（1つのアロケータ）で実行し、並行生成でも競合を防ぐ。
3. 検索集合外IDは拒否または`[?]`化し、監査ログに残す。
4. ストリーム後段で本文改変を行う場合は、改変前に安全化する。改変後に再採番すると不変性が壊れる。

## 5. 結論
初出順単調割当方式は、ストリーミングRAGの引用表示問題に対して最小実装で有効である。
同一の採番状態を「生成中表示」と「終了時一覧」に共有することが、要件達成の本質である。
