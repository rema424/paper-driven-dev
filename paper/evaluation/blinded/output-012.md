# Output #012

# マルチテナントSaaSにおける低遅延・即時失効対応セッション管理方式の設計

## 要旨
本稿は、マルチテナントSaaS向けセッション管理において、(1)同一ユーザーの複数端末同時ログイン、(2)管理者による即時失効、(3)水平スケーリング、(4)認証レイテンシ最小化、を同時達成する設計を提案する。提案方式は「短命アクセストークン＋状態管理付きリフレッシュトークン＋ユーザー単位バージョン管理」を核とし、L1メモリキャッシュと分散KVSを併用する。特に失効操作を「ユーザーバージョンの単調増加」に還元することで、全端末セッションをO(1)で無効化できる。理論的には、通常時は署名検証とローカルキャッシュ参照のみで認証を完了し、失効時はイベント配信により全ノードへ即時伝播する。

**キーワード**: マルチテナント, セッション管理, 即時失効, 水平スケーリング, 低レイテンシ

## 1. 問題設定
SaaSでは認証を無状態化するとスケールしやすい一方、即時失効が難しい。逆に完全状態管理は失効制御に強いが、認証ごとのI/O増加で遅延が増える。本研究課題は、両者の利点を統合する設計である。

## 2. 提案方式
### 2.1 アーキテクチャ
構成要素は以下とする。
- `API Gateway/Auth Middleware`（ステートレス、水平分散）
- `Token Issuer`（署名鍵管理）
- `Redis Cluster`（セッション状態・ユーザーバージョン・Pub/Sub）
- `RDB`（監査ログ、永続化）

### 2.2 データモデル（テナント分離）
- `user_version:{tenant_id}:{user_id} -> int`
- `session:{tenant_id}:{session_id} -> {user_id, refresh_hash, status, expires_at}`
- すべてのキーに`tenant_id`を含め、論理分離を強制する。

### 2.3 トークン設計
- アクセストークン（短命、例: 2〜5分）
  `claims = {tenant_id, user_id, session_id, user_version, exp, iat, jti}`
- リフレッシュトークン（長命、サーバー保管のハッシュと照合）

## 3. プロトコル
### 3.1 ログイン（複数端末対応）
端末ごとに`session_id`を発行し、独立したリフレッシュトークンを持たせる。これにより同一ユーザーの同時ログインを自然に許容する。

### 3.2 リクエスト認証（低遅延）
1. アクセストークン署名をローカル検証
2. `user_version`をL1キャッシュ参照（ミス時のみRedis）
3. `token.user_version == current_user_version`なら許可

### 3.3 管理者による即時失効
対象ユーザーの全セッション失効は以下で実行する。
1. `INCR user_version:{tenant}:{user}`（原子的更新）
2. 失効イベントをPub/Sub配信
3. 各GatewayがL1キャッシュを即時更新

この結果、旧`user_version`を持つ全アクセストークンは直ちに無効化される。

## 4. 要件適合性
| 要件 | 達成メカニズム |
|---|---|
| 複数端末同時ログイン | 端末単位`session_id`と独立リフレッシュトークン |
| 特定ユーザー即時失効 | `user_version`のインクリメントとイベント伝播 |
| 水平スケーリング | 認証ノードのステートレス化＋共有分散KVS |
| レイテンシ最小化 | ローカル署名検証＋L1キャッシュ優先 |

## 5. 性能・整合性の考察
期待認証遅延を
`E[L] = L_sig + h*L_L1 + (1-h)*L_redis`
とすると、L1ヒット率`h`を高めるほど遅延は低下する。失効反映遅延は概ね
`D <= max(D_pubsub, TTL_L1)`
で上界化できる。したがって、`TTL_L1`を短くし、Pub/Sub監視を強化することで「即時性」と「低遅延」の両立が可能である。

## 6. 実運用上の補足
- フェイルセーフ: Redis障害時は高権限APIを`fail-closed`、一般APIは短時間`fail-soft`など方針分離
- 鍵管理: 署名鍵ローテーションと`kid`運用
- 監査: 失効操作を監査ログへ必ず永続化

## 7. 結論
提案方式は、トークン無状態認証の高速性と、状態管理による即時失効制御を統合し、4要件を同時に満たす。特に`user_version`方式により、管理者のユーザー単位失効を単一原子操作へ還元でき、マルチテナントSaaSに適した実装容易性と運用性を提供する。
