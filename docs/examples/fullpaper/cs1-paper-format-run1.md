# CS1 条件B: Paper-format — RAG引用リナンバリング (Run 1)

> **Run**: CS1-B-Run1
> **Date**: 2026-02-20
> **Thread**: 新規 (Codex MCP: 019c76bd-530a-7c62-a887-6f29e84e7d8a)
> **Model**: GPT-5.2 (via Codex)

---

**題目**
ストリーミングRAGにおける不変な逐次引用番号付与のオンライン設計

**要旨**
RAGシステムのストリーミング生成では、生成途中にどのソースが最終的に参照されるか未確定であるため、読みやすい連番引用（例: [1], [2]）の提示が難しい。本稿は「(i) ストリーミング中にリアルタイム表示」「(ii) 一度表示した番号は不変」「(iii) 完了時にソース一覧と整合」を同時に満たすため、LLM出力中の"ソースキー参照"を中間層で"逐次番号"へオンライン変換する設計を提案し、正当性と実装上の留意点を示す。

---

### 1. 序論
LLMが `source_3` や `source_7` のような検索結果IDを根拠として回答する場合、ユーザー提示は脚注形式の連番が望ましい。一方、ストリーミングは逐次確定（多くは追記型）であり、後から番号の付け替え（再番号付け）は要件(ii)に反する。

### 2. 要件
- **R1**: ストリーミング中、本文内に引用番号を即時表示する。
- **R2**: 一度表示した引用番号は後から変えない。
- **R3**: ストリーム完了時、表示済み番号とソース一覧（参考文献）が一致する。

### 3. 提案方式：ソースキー→番号のオンライン割当（First-Use Numbering）
#### 3.1 LLM出力は「番号」ではなく「ソースキー」を出す
LLMには `[1]` のような番号を直接出させず、機械可読な引用マーカーで **ソースキー** を出力させる。例：
- 単一: `⟦cite:source_7⟧`
- 複数: `⟦cite:source_3,source_7⟧`
（マーカーは衝突しにくい文字列にし、ストリーミング中に部分到着しても復元可能な文法にする。）

#### 3.2 Citation Resolver（中間層）で逐次番号を確定・置換する
ストリームを受け取る中間層が、以下の状態を保持する：
- `M: source_key -> int`（割当済み番号）
- `L: [source_key]`（初出順リスト）
- `next`（次に割り当てる番号、初期値1）

オンライン処理（概略）：
```
引用マーカーを検出したら、含まれるsource_keyごとに
未割当なら M[key]=next, Lにkey追加, next++
その場で [M[key]] に置換してクライアントへ送る
```
この「初出時に確定」規則により、番号は生成途中で確定し、その後変化しない。

#### 3.3 完了時に参考文献一覧を構成する
ストリーム完了時、`L` の順にソースメタデータ（タイトル、URL、スニペット等）を列挙して `[n]` と対応付けて表示する。本文中の番号は `M` から出ているため、一覧も同じ `M/L` から生成すれば必ず整合する。

### 4. 正当性（要件充足の議論）
- **R1（リアルタイム）**：マーカー検出時に即座に番号を割り当て、その場で `[n]` を出力できる（オンライン、低遅延）。
- **R2（不変）**：`M` は「未割当のみ追加・既存は参照のみ」の単調増加写像であり、発行済み番号を再代入しないため不変。
- **R3（整合）**：本文内の `[n]` は必ず `M` 由来であり、一覧も `L`（初出順）と `M` から生成するので、番号とソースが1対1に対応する。

### 5. 実装上の留意点
- **分割到着**：マーカー文字列がトークン境界で分割されるため、終端（例：`⟧`）までバッファリングしてから解釈する。
- **未知キー対策**：`source_key` は「検索結果集合に存在するIDのみ許可」とし、中間層で検証する（未知ならエラーにして生成を中断／または `[?]` として"未解決エントリ"を一覧に出す等、方針を明確化）。
- **LLMの番号出力抑止**：LLMが勝手に `[1]` を生成すると混乱するため、プロンプトと出力検証で「引用は必ずマーカーで」と制約する。
- **UI/プロトコル代替**：本文テキストに置換埋め込みせず、`text-delta` と `citation-event{key,number}` を別チャネルで送る設計にすると、パーサの複雑性と誤検出を下げられる（ただしクライアント実装は重くなる）。

### 6. 結論
ストリーミング中の引用番号付与は、(a) LLMにソースキーを出力させ、(b) 中間層で「初出順に番号を確定し即時表示」し、(c) 同一状態から参考文献一覧を生成する、というオンライン変換で要件R1–R3を同時に満たせる。必要条件は、引用を番号ではなくキーで表現すること、番号割当を単調・不変にすること、一覧生成を同一の割当状態に基づけることである。
