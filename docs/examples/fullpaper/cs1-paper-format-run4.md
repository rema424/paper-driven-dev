# CS1 条件B: Paper Format — RAG引用リナンバリング (Run 4)

> **Run**: CS1-B-Run4
> **Date**: 2026-02-20
> **Thread**: 新規 (Codex MCP: 019c79ac-6d29-7050-866d-cad73f0a9dab)
> **Model**: GPT-5.2 (via Codex)

---

# ストリーミングRAGにおける不変引用番号付与のオンライン設計

## 要旨
RAGシステムのストリーミング生成では、回答本文が未確定な状態で引用を提示する必要がある。本稿は、(1) リアルタイム表示、(2) 番号不変性、(3) 最終ソース一覧との整合性、の3要件を同時に満たす設計として、**初出順オンライン番号付与方式**を提案する。提案方式は、`source_id -> 表示番号` の不変写像をストリーム中に逐次確定し、完了時に同一写像から参考文献一覧を生成する。これにより、番号再割当を不要化し、UI整合性を保証できる。

**キーワード**: RAG, ストリーミング生成, 引用管理, 一貫性, オンラインアルゴリズム

## 1. 問題設定
LLMは `source_3`, `source_7` など内部IDを参照しつつトークンを逐次出力する。一方、ユーザー向けには `[1]`, `[2]` の可読な連番が望ましい。ここで、ストリーミング中は将来どのソースが出現するか未確定であるため、後から再番号付けを行う設計は表示の不整合を生む。

## 2. 要件
本問題の必須要件を次の3つとする。

1. ストリーミング中に引用番号を即時表示できること。
2. 一度表示した番号が後から変わらないこと。
3. ストリーム完了時のソース一覧が本文番号と一致すること。

## 3. 提案方式
### 3.1 生成フォーマットの正規化
LLMには数値引用を直接出させず、`[[source_3]]` のような**正規化引用タグ**を出力させる。表示番号化は後段ミドルウェアで行う。

### 3.2 初出順オンライン番号付与
データ構造:
- `R`: 検索で得た有効ソースID集合
- `M`: `source_id -> citation_number`（不変HashMap）
- `next`: 次に割り当てる番号（初期値1）

処理:
```text
for each streamed citation tag c:
    if c not in R:
        mark as unresolved (表示しない/警告表示)
    else if c not in M:
        M[c] = next
        next += 1
    emit "[" + M[c] + "]"
```

### 3.3 チャンク境界対応
タグがチャンク分断されるため、有限状態機械（FSM）で `[[...]]` 完了まで短いバッファ保持を行う。これにより誤検出を防ぐ。

## 4. 正当性
**命題1（不変性）**
任意時刻 `t` で割り当て済み `c` に対し、以後 `M[c]` は不変。
理由: `M[c]` は未登録時のみ代入され、上書き操作が存在しない。

**命題2（リアルタイム性）**
各引用タグ処理は平均 `O(1)`。
理由: HashMap参照と定数回演算のみ。

**命題3（最終整合性）**
完了時一覧 `B[k] = meta(M^{-1}(k))` と本文表示番号は一致。
理由: 本文番号と一覧生成の双方が同一写像 `M` を唯一の真実源として参照する。

## 5. 実装上の設計要点
1. セッション単位で `M` を永続化し、再接続時に復元する。
2. `source_id` 妥当性検証を必須化し、未知IDを隔離する。
3. UIは本文描画と一覧描画を分離し、一覧は完了時に `M` から確定生成する。
4. LLM再試行時も同一 `M` を継続利用し、番号の時間的一貫性を保つ。

## 6. 例
検索結果: `{source_7, source_3, source_2}`
生成順: `[[source_7]]`, `[[source_3]]`, `[[source_7]]`
表示: `[1]`, `[2]`, `[1]`
最終一覧:
`[1] source_7`
`[2] source_3`

## 7. 結論
提案した初出順オンライン番号付与方式は、ストリーミングRAGにおいて要求された3条件を同時に満たす。特に、**番号不変性を写像 `M` の単調拡張として定義**し、本文表示と最終一覧を同一データ源に統一する点が実装上の中核である。これにより、ユーザー体験とシステム整合性を高い水準で両立できる。
