# Output #010

§1. 問題定義
§1.1 背景
マルチテナントSaaSでは、認証は「利便性（複数端末利用）」と「統制（即時失効）」を同時に満たす必要があります。加えて、トラフィック変動に応じた水平スケーリングを前提とするため、特定ノードに依存しないセッション管理が必要です。認証経路は全リクエストで実行されるため、レイテンシ最小化は全体性能に直結します。

§1.2 矛盾する要求（対立するトレードオフ）
1. 即時失効性 vs 低レイテンシ
失効判定を厳密にするほど外部参照が増え、認証遅延が増加します。
2. ステートレス性 vs 管理可能性
完全ステートレス（JWTのみ）はスケールしやすい一方、管理者による強制失効が困難です。
3. 複数端末同時ログイン vs 攻撃面積最小化
端末ごとにセッションを増やすと、盗用トークンの有効面積も増大します。

§1.3 本文書の範囲
本稿は「セッション有効性判定と失効制御」の設計を対象とし、認証方式自体（MFA方式、IdP選定）は扱いません。単一リージョン内での強整合寄り運用を前提に、マルチテナント分離を必須要件とします。

§2. 現状のアーキテクチャと制約
想定アーキテクチャは、`API Gateway`、ステートレス`App Node`群、`Auth Service`、`Redis Cluster`、`RDBMS`です。
制約は以下です。
1. App Nodeはオートスケールし、スティッキーセッションは不可。
2. テナント越境参照は禁止（キー設計に`tenant_id`必須）。
3. 失効操作は管理画面から即時反映が必要。
4. 認証は高頻度パスのため、外部I/O回数を最小化する必要があります。

§3. 既存アプローチとその限界
§3.1 アプローチ1: サーバーセッション集中管理 — 手法 / 利点 / 限界
手法: セッションIDをDB/Redisで毎回照会。
利点: 失効が容易で管理しやすい。
限界: 毎回ネットワークI/Oが発生し、低レイテンシ要件に不利。

§3.2 アプローチ2: JWT完全ステートレス — 手法 / 利点 / 限界
手法: 署名検証のみで認証可否を決定。
利点: 高速・高スケール。
限界: 発行済みトークンの即時失効が難しく、管理者統制が弱い。

§3.3 アプローチ3: トークンイントロスペクション集中化 — 手法 / 利点 / 限界
手法: 認可サーバーに都度問い合わせ。
利点: 失効整合性が高い。
限界: 集中ボトルネック化しやすく、水平スケール時の遅延とコストが増加。

§4. 問題の本質
本問題は「分散環境における失効整合性」と「リクエスト単位の定数時間判定」の両立問題です。
要点は、認証判定に必要な状態を最小化し、かつ失効イベントを全ノードへ低遅延伝播させることです。

§5. 提案手法
§5.1 基本原理
1. 二層失効モデル
`session_id`単位失効（端末単位）と`user_epoch`失効（ユーザー全端末）を併用します。
2. Push + Pull整合
通常は失効イベントをPub/Subで即時配信（Push）、取りこぼし時はRedis再照会（Pull）で補正します。
3. 短命Access Token + 状態付きRefresh Token
Access Tokenは短TTL（例: 5分）で局所判定を高速化し、Refresh時に最新失効状態を必ず反映します。

§5.2 実装アーキテクチャ
1. データ構造
`ue:{tenant}:{user} -> user_epoch`
`ss:{tenant}:{sid} -> status(active/revoked), exp`
2. ログイン
端末ごとに`sid`を発行し、JWTに`tenant_id, user_id, sid, epoch, exp`を格納。
3. 認証（通常経路）
JWT署名をローカル検証し、L1メモリキャッシュで`epoch`と`session status`を判定。ミス時のみRedis照会。
4. 管理者失効（ユーザー全体）
`user_epoch`を原子的にインクリメントし、失効イベントを配信。各ノードはL1更新により旧epochトークンを即時拒否。
5. 管理者失効（特定端末）
該当`sid`を`revoked`へ更新し、同様にイベント配信。

§6. 検証可能な性質 — Given/When/Then
1. 性質A（複数端末同時ログイン）
Given: 同一ユーザーが端末A/Bでログイン済み
When: 端末AがAPIを呼び出す
Then: 端末Bの存在に影響されず、A/Bとも独立に認証成功する

2. 性質B（ユーザー即時失効）
Given: ユーザーに有効セッションが3件存在
When: 管理者が当該ユーザー失効を実行
Then: 以降の全端末リクエストは旧epochとして拒否される

3. 性質C（端末単位失効）
Given: 端末A/Bが有効
When: 管理者が端末Aの`sid`のみ失効
Then: Aは拒否され、Bは継続利用できる

4. 性質D（水平スケーリング耐性）
Given: App Node数をNから2Nへ変更
When: 同一負荷プロファイルで認証処理を実行
Then: スティッキーセッションなしで同等の正当性を維持する

5. 性質E（低レイテンシ）
Given: L1キャッシュヒット率が高い運用状態
When: 認証リクエストを処理
Then: 認証判定は外部I/Oなしで完結し、遅延は最小化される

§7. 制約と今後の課題
1. 「即座」の厳密定義
分散系では伝播遅延が不可避なため、`失効反映p99 < X ms`のSLO定義が必要です。
2. マルチリージョン展開
リージョン間で整合遅延が増えるため、epoch整合戦略（優先リージョン/因果順序保証）の追加設計が必要です。
3. 運用課題
失効イベント監視、取りこぼし再同期、テナント別鍵ローテーションの自動化が必要です。
4. 評価課題
負荷試験（レイテンシ分布）と障害注入試験（Pub/Sub遅延・Redisフェイルオーバ）による実証が今後の主要課題です。
