# Output #014

1. 問題の背景と文脈
RAGでは、LLMが内部ID（`source_3` など）を参照しながらトークンを逐次出力します。
一方、UIはユーザー向けに `[1] [2] [3]` の連番表示を求めます。
課題は「ストリーミング中は最終的な参照集合が未確定」な点です。

2. 対立する要求やトレードオフ
- 即時表示 vs 正確性: 早く表示するほど、後続文脈で不要になる参照を確定しやすい。
- 番号不変 vs きれいな連番: 不変性を守ると、場合によっては欠番や未使用番号が発生し得る。
- 実装単純性 vs 堅牢性: 単純な文字列置換は速いが、分割チャンクや再送、未知IDに弱い。

3. 分析の対象範囲
- 対象: 1回の回答ストリーム内での引用番号付与、UI表示、最終ソース一覧整合。
- 非対象: 検索品質改善、引用の意味的妥当性判定、会話ターンをまたぐ通番ポリシー。

4. 現状のアーキテクチャと制約
- LLM出力はチャンク分割され、引用トークンが途中で分断される。
- UIは通常、過去テキストの大規模書き換えに弱い（追記中心）。
- バックエンドが分散構成だと、番号状態の共有が必要。
- 要件上、いったん表示した番号は再割当不可。

5. 既存の解決アプローチとその限界
5.1 アプローチ1: 後処理一括採番 — 手法 / 利点 / 限界
- 手法: ストリーム完了後に全文を解析して `[1..N]` を付与。
- 利点: 最終整合は取りやすい。
- 限界: リアルタイム表示要件を満たせない。

5.2 アプローチ2: 検索順位の事前固定採番 — 手法 / 利点 / 限界
- 手法: 取得時点で `source_k -> [rank]` を固定。
- 利点: 番号不変は満たしやすい。
- 限界: 未使用ソースが混ざり、表示番号が読みにくくなりやすい。

5.3 アプローチ3: 自然文から正規表現抽出 — 手法 / 利点 / 限界
- 手法: 出力テキストから `source_x` を逐次検出して番号化。
- 利点: 既存LLM出力に後付けしやすい。
- 限界: 曖昧表記・分割チャンク・誤検出に弱く、整合性が壊れやすい。

6. 問題の本質的な困難
これは「未来未確定のオンライン割当問題」です。
番号は先に見せたいが、最終的に使われる参照は後まで確定しません。
したがって、`source_id` と表示番号を分離し、オンラインで単調増加・再割当なしで管理する必要があります。

7. 解決策
7.1 基本原理
- 引用ID（`source_7`）と表示番号（`[2]`）を分離する。
- 「有効な引用タグを初めて確定検出した時点」でのみ番号を採番する。
- 採番表は append-only（追加のみ）で、再番号付けしない。
- 最終ソース一覧は採番表から生成し、本文と機械的に照合する。

7.2 実装方針
- LLM出力形式を構造化する（例: `<cite:source_7>`）。
- ストリームパーサを状態機械化し、チャンク分断を吸収する。
- `CitationAllocator` を用意し、`Map<source_id, number>` と `next_number` を保持する。
- 新規ID検出時のみ `next_number` を割当てて `[n]` を即時出力し、同時にソース一覧イベントをUIへ送る。
- 既出IDは既存番号を再利用する。
- 未知IDは `[?]` などのポリシーで処理し、採番は消費しない。
- 完了時に「本文の番号集合」と「一覧の番号集合」の一致を検証し、不一致はエラーとして記録する。

8. 検証条件（Given/When/Then）
- Given 許可IDが `source_3, source_7`、When `source_3 -> source_7 -> source_3` の順に引用、Then 本文は `[1][2][1]` となり一覧は `1=source_3, 2=source_7`。
- Given 引用タグがチャンク分割、When 後半チャンク到着前、Then 番号は表示されない。到着後に1回だけ表示される。
- Given 未許可 `source_99`、When 検出、Then `[?]`（または非表示）で処理し、既存番号は変化しない。
- Given 再送で同一チャンクが重複、When 重複排除を有効化、Then 採番は重複せず不変。
- Given ストリーム正常終了、When 最終検証実行、Then 本文引用番号とソース一覧は完全一致する。

9. 制約、限界、今後の課題
- LLMが構造化タグを守らない場合に備え、出力制約やバリデータが必須。
- この方式は「番号整合」を保証するが、「引用内容の正しさ」は別問題。
- 不変性を優先するため、運用次第で欠番風の見え方が起こり得る。
- 今後は、制約付きデコーディング、引用妥当性チェッカー、再接続時の厳密な冪等制御を強化するとよいです。
