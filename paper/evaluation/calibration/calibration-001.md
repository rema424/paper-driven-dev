# Calibration #001

# マルチテナントSaaSにおけるセッション管理方式の選定：即時失効と水平スケーリングを両立する設計

## 要旨
マルチテナントSaaSでは、(i)複数デバイス同時ログイン、(ii)管理者による特定ユーザー（または特定デバイス）のセッション即時無効化、(iii)水平スケーリング、(iv)低レイテンシ、を同時に満たす必要がある。本稿は代表的方式を比較し、**オンライン失効判定可能なサーバサイド・セッションレジストリ（例：Redis）を中核に、検証点をAPIゲートウェイ（またはBFF）へ集約し、必要に応じてL1キャッシュ＋失効通知で遅延を抑える方式**を推奨する。

**キーワード**：マルチテナント、セッション失効、水平スケーリング、Redis、JWT、イントロスペクション

---

## 1. はじめに
セッション管理は「認証結果の再利用」によりレイテンシを削減する一方、「失効（revocation）」は状態管理を要求し、分散環境では一貫性と性能が衝突する。特に"即時無効化"は、**少なくとも次リクエスト時点で必ず拒否できる**ことを意味し、純粋なステートレス方式（自己完結トークンの長寿命運用）では満たしにくい。

---

## 2. 要件整理（機能・非機能）
- **複数デバイス同時ログイン**：ユーザーに対して複数セッションの並存が必須（端末単位の識別・管理が望ましい）。
- **管理者による即時無効化**：ユーザー単位（全端末）／セッション単位（特定端末）の双方を想定。
- **水平スケーリング**：アプリサーバは原則ステートレス、どのノードでも同様に判定できること。
- **低レイテンシ**：DB参照の常態化を避け、インメモリ系ストアや検証点集約でホットパスを短縮。

---

## 3. 代表方式の比較
| 方式 | 即時無効化 | 水平スケール | レイテンシ | 主な課題 |
|---|---:|---:|---:|---|
| A. サーバサイドセッションID（共有ストア参照） | ◎ | ◎ | ○（ストア往復） | ストア依存・設計不備で単一障害点化 |
| B. ステートレスJWT（署名検証のみ） | ×（原則不可） | ◎ | ◎ | 漏洩時の封じ込めが弱い／即時失効不可 |
| C. JWT＋失効リスト（jtiブラックリスト等） | ◎ | ◎ | △（参照必須） | 失効リスト肥大・参照コスト |
| D. イントロスペクション（不透明トークン＋毎回照会） | ◎ | ◎ | △（照会必須） | ゲートウェイ設計が重要 |

結論として、要件(ii)が強い以上、B単独は不適。A/C/Dはいずれも成立するが、低レイテンシ要件を踏まえると、**検証点を1箇所に集約し、インメモリ共有ストアでO(1)照会するA/D系**が実装・運用上の整合が取りやすい。

---

## 4. 推奨アーキテクチャ（選定結果）
### 4.1 基本方針
- **クライアント提示トークン**：不透明なランダム値（セッションID、以下SID）を推奨
  - 例：HTTP Only Cookie（Web）またはAuthorization Bearer（モバイル/SPA）
- **サーバサイド・セッションレジストリ**：Redis等の分散インメモリKVS
  - `tenant_id`で名前空間分離（キーに必ず含める）
- **検証点の集約**：APIゲートウェイ/BFFでSIDを検証し、内部へはユーザー文脈を伝搬（必要なら内部用の短寿命JWTを再発行）

### 4.2 データモデル（概念）
- `Session(tenant_id, sid, user_id, device_id, status, issued_at, expires_at, last_seen, ... )`
- 失効操作
  - **セッション単位失効**：`sid`を削除 or `status=revoked`
  - **ユーザー単位（全端末）失効**：`user_revoked_after`（タイムスタンプ）または`user_session_version`（世代）を更新し、判定に組み込む

### 4.3 リクエスト処理（ホットパス最小化）
1. ゲートウェイがSIDを受領
2. Redisで`GET session:{tenant}:{sid}`（必要最小限の1回照会を目標）
3. 有効ならユーザー文脈（user_id/tenant_id/roles）を内部へ付与して転送
   - 追加最適化：**L1（プロセス内）キャッシュ**＋**失効通知（Pub/Sub等）で即時パージ**
   - "即時"要件が厳密なら、L1キャッシュTTLは極小化または無効化し、常にRedis参照する

---

## 5. 要件適合性評価
- **複数デバイス同時ログイン**：SIDを端末ごとに発行し、セッション一覧を持てるため◎
- **管理者による即時無効化**：Redis上のキー削除（または失効フラグ）で次リクエストから確実に拒否でき◎
- **水平スケーリング**：アプリノードはステートレス、共有ストア参照で整合を取れるため◎
- **低レイテンシ**：照会先をRedisに限定し、検証点をゲートウェイに集約することで、サービス横断の重複検証を抑え○（要件(ii)を満たす範囲での最小化）

---

## 6. 運用・セキュリティ上の考慮
- **マルチテナント分離**：キー設計・認可チェックで`tenant_id`越境を防ぐ（管理者操作も同一テナントに限定）。
- **耐障害性**：Redisクラスタリング／マルチAZ、タイムアウト時のフェイルクローズ方針（認証は原則クローズ）を明確化。
- **監査性**：失効操作（誰が・いつ・どの範囲）を永続DBに監査ログとして記録。
- **トークン漏洩対策**：SIDは高エントロピー、必要に応じて端末情報・ローテーション・異常検知を導入。

---

## 7. 結論
提示要件の中核である「即時無効化」はサーバサイド状態を要求するため、**共有セッションレジストリ（Redis等）に基づく不透明SID方式（イントロスペクション型）**が最も適合する。低レイテンシは、**検証点のゲートウェイ集約**と**インメモリKVSのO(1)参照**、（許容できる範囲での）**L1キャッシュ＋失効通知**により達成可能である。

---

### 参考文献（代表）
- RFC 6749: The OAuth 2.0 Authorization Framework
- RFC 7519: JSON Web Token (JWT)
- OWASP ASVS / OWASP Session Management Cheat Sheet
